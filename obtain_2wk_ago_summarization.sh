#!/bin/bash

file_in_hdfs=`/a/third-party/hadoop/bin//hadoop fs -ls /ghostcache/hadoop/data/MRQOS/mrqos_sum/ | tail -14 | head -1 | awk '{print $NF}'`
file_local="/home/testgrp/MRQOS/mrqos_data/summarized_processed_14d.tmp"
ts_2w=`echo $file_in_hdfs | cut -d"=" -f2`
ts_now=`/a/third-party/hadoop/bin//hadoop fs -ls /ghostcache/hadoop/data/MRQOS/mrqos_sum/ | tail -1 | awk '{print $NF}' | cut -d"=" -f2`

if [[ -e $file_local ]]; then rm $file_local; fi;

/a/third-party/hadoop/bin//hadoop fs -copyToLocal $file_in_hdfs/summarized_processed.tmp $file_local

/a/third-party/hive/bin//hive -e "set mapred.child.java.opts=-Xmx2000m; use mrqos; set hive.cli.print.header=true; SELECT b.ts_2w, a.*, b.sp95_t95_2w, b.dp95_t95_2w, b.ocy_t95_2w, b.oct_t95_2w FROM (SELECT ts ts_now, maprule, geoname, netname, sp95_t95, dp95_t95, 100-icy_t95 ocy_t95, 100-ict_t95 oct_t95, total_mbps from mrqos_sum where ts='$ts_now' ) a JOIN ( select maprule, geoname, netname, sp95_t95 sp95_t95_2w, dp95_t95 dp95_t95_2w, 100-icy_t95 ocy_t95_2w, 100-ict_t95 oct_t95_2w, ts ts_2w from mrqos_sum where ts='$ts_2w' ) b ON ( a.maprule = b.maprule AND a.geoname = b.geoname AND a.netname = b.netname )" > /home/testgrp/MRQOS/mrqos_data/processed_2wjoin.tmp

/a/third-party/hive/bin//hive -e "set mapred.child.java.opts=-Xmx2000m; use mrqos; set hive.cli.print.header=true; SELECT b.ts_2w, a.*, b.sp95_t95_2w, b.sp95_t90_2w, b.sp75_t95_2w, b.sp75_t90_2w, b.dp95_t95_2w, b.dp95_t90_2w, b.dp75_t95_2w, b.dp75_t90_2w, b.ocy_t95_2w, b.ocy_t90_2w, b.oct_t95_2w, b.oct_t90_2w FROM (SELECT ts ts_now, maprule, geoname, netname, sp95_t95, sp95_t90, sp75_t95, sp75_t90, dp95_t95, dp95_t90, dp75_t95, dp75_t90, 100-icy_t95 ocy_t95, 100-icy_t90 ocy_t90, 100-ict_t95 oct_t95, 100-ict_t90 oct_t90, total_mbps from mrqos_sum where ts='$ts_now' ) a JOIN ( select maprule, geoname, netname, sp95_t95 sp95_t95_2w, sp95_t90 sp95_t90_2w, sp75_t95 sp75_t95_2w, sp75_t90 sp75_t90_2w, dp95_t95 dp95_t95_2w, dp95_t90 dp95_t90_2w, dp75_t95 dp75_t95_2w, dp75_t90 dp75_t90_2w, 100-icy_t95 ocy_t95_2w, 100-icy_t90 ocy_t90_2w, 100-ict_t95 oct_t95_2w, 100-ict_t90 oct_t90_2w, ts ts_2w, total_mbps total_mbps_2w from mrqos_sum where ts='$ts_2w' ) b ON ( a.maprule = b.maprule AND a.geoname = b.geoname AND a.netname = b.netname )" > /home/testgrp/MRQOS/mrqos_data/processed_2wjoin_full.tmp

/a/third-party/hive/bin//hive -e "set mapred.child.java.opts=-Xmx2000m; use mrqos; set hive.cli.print.header=true; SELECT b.ts_2w, a.*, b.sp95_t95_2w, b.sp95_t90_2w, b.sp75_t95_2w, b.sp75_t90_2w, b.dp95_t95_2w, b.dp95_t90_2w, b.dp75_t95_2w, b.dp75_t90_2w, b.ocy_t95_2w, b.ocy_t90_2w, b.oct_t95_2w, b.oct_t90_2w, b.total_mbps_2w FROM (SELECT ts ts_now, maprule, geoname, netname, sp95_t95, sp95_t90, sp75_t95, sp75_t90, dp95_t95, dp95_t90, dp75_t95, dp75_t90, 100-icy_t95 ocy_t95, 100-icy_t90 ocy_t90, 100-ict_t95 oct_t95, 100-ict_t90 oct_t90, total_mbps from mrqos_sum where ts='$ts_now' ) a JOIN ( select maprule, geoname, netname, sp95_t95 sp95_t95_2w, sp95_t90 sp95_t90_2w, sp75_t95 sp75_t95_2w, sp75_t90 sp75_t90_2w, dp95_t95 dp95_t95_2w, dp95_t90 dp95_t90_2w, dp75_t95 dp75_t95_2w, dp75_t90 dp75_t90_2w, 100-icy_t95 ocy_t95_2w, 100-icy_t90 ocy_t90_2w, 100-ict_t95 oct_t95_2w, 100-ict_t90 oct_t90_2w, ts ts_2w, total_mbps total_mbps_2w from mrqos_sum where ts='$ts_2w' ) b ON ( a.maprule = b.maprule AND a.geoname = b.geoname AND a.netname = b.netname )" > /home/testgrp/MRQOS/mrqos_data/processed_2wjoin_full_wloads.tmp

