SELECT CURRENT_TIMESTAMP,
       abc.casename                    casename,
       Sum(CASE
             WHEN bytes > 0
             THEN 100 * bytes_in / bytes * percentage / d.coverage_pct
             ELSE 0.0
           END)                        in_out_ratio,
       Max(targetvalue)                targetvalue,
       Cast(d.coverage_pct AS INTEGER) coverage_pct
FROM   (SELECT ab.casename casename,
               bytes_in,
               bytes,
               percentage,
               targetvalue
        FROM   (SELECT a.maprule     maprule,
                       a.geoname     geoname,
                       a.netname     netname,
                       a.targetvalue targetvalue,
                       b.casename    casename,
                       b.geo         geo,
                       b.aslist      aslist,
                       b.regionid    regionid,
                       b.percentage  percentage
                FROM  (SELECT maprule,
                              geoname,
                              netname,
                              Min(targetvalue) targetvalue
                       FROM   mrpm_maprule_qos_objectives
                       WHERE  attrname = 'IN-OUT-RATIO'
                              AND maprule IN ( 198,2905,2910,2923,2948,121,2911,1,122,151,152,197,290,2903,2916,2952,2957,2959,2962,3,332,4112,4114,4120,4663,4666,4667,4668,4669,9634,9636,9637,9638,9639,9644,9645,9646,2953,146,147,150,154,155,159,160,2,2913,2940,2941,2942,2943,2955,334,4992,95,4001,4002,4003,4004,480,481,482,4111,7401,2934,6,7,106,107,153,158,185,21,25,2906,2914,2919,2922,2924,2927,2928,2929,2935,2944,2945,2947,2951,2954,2964,2965,2966,2967,2972,2973,2983,31,4006,4007,4113,4116,4323,4363,4364,4370,4671,4672,4673,4674,4676,4677,4678,4679,4680,4681,4682,4683,4701,4704,4719,4725,476,4764,477,4776,4779,4782,4785,4812,4818,5424,5425,7402,7407,7409,86,9081,9086,9089,9090,9091,9095,9126,9127,9128,9129,9130,9131,9132,9133,9440,9441,9442,9443,96,9631,9632,9633,9690,9691,97,4662,2907,4322,4665,4815,5016,5018,5694,2956,2904,4655,35,7414,2939,2950,4991,22,88,382,436,4906,4907,4908,4909,4910,4911,4912,4913,4914,4915,251,252,4385,388,399,400,12,82,2712,401,4382,444,4500,4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4512,4513,4514,4515,4516,4517,4518,4519,4520,4521,4522,4523,4524,4525,4526,4527,4528,4529,4530,4531,4532,4533,4534,4535,4536,4537,4538,4539,5027,5684,5695,7670,7671,7672,7673,7674,7675,7676,7677,7678,7679,7680,7681,7682,7683,7684,7685,7686,7687,7688,7689,7690,7691,7692,7693,7694,7695,7696,7697,7698,7699,2970,2720,36,4384,4386,94,4936,11200,11210,11220,11230,11240,11297,11298,11299,4937,4938,4939,149,29,2770,2771,2772,2773,2774,2775,2776,2777,2778,2779,2780,2781,2782,2783,2784,2785,2786,2787,2788,2789,7647,7648,7660,7661,7662,7663,7664,7665,7666,7667,7668,7669,7950,7951,7952,7953,7954,7955,7956,7957,127,30,2527,2528,2529,26,27,2714,28,443,81,91,92,93,191,33,157,20,2640,2641,2642,2643,2644,2645,2646,2647,2648,2649,465,466,467,468,469,470,471,472,473,474,125,126,199,2516,487,4872,4873,4874,108,11,11519,11520,136,137,156,249,250,253,255,256,4658,489,2971,168,2685,2912,2968,2969,4657,4857,5658,18,2716,2717,2718,2719,4550,4551,4552,4553,4554,4555,4556,4557,4558,4559,2510,2578,2670,2671,2672,2673,2674,2675,2680,2686,2721,2722,2723,2724,2725,2790,2791,2792,2793,2794,2795,2796,2797,2798,2799,387,7646,7900,7901,7902,7903,7904,7905,7906,7907,7908,7909 )
                       GROUP  BY 1,
                                 2,
                                 3) a,
                      (SELECT Max(casename)   casename,
                              mapruleid,
                              geo,
                              aslist,
                              regionid,
                              Max(percentage) percentage
                       FROM   a_maprule_qos_view_by_region
                       WHERE  mapruleid IN ( 198,2905,2910,2923,2948,121,2911,1,122,151,152,197,290,2903,2916,2952,2957,2959,2962,3,332,4112,4114,4120,4663,4666,4667,4668,4669,9634,9636,9637,9638,9639,9644,9645,9646,2953,146,147,150,154,155,159,160,2,2913,2940,2941,2942,2943,2955,334,4992,95,4001,4002,4003,4004,480,481,482,4111,7401,2934,6,7,106,107,153,158,185,21,25,2906,2914,2919,2922,2924,2927,2928,2929,2935,2944,2945,2947,2951,2954,2964,2965,2966,2967,2972,2973,2983,31,4006,4007,4113,4116,4323,4363,4364,4370,4671,4672,4673,4674,4676,4677,4678,4679,4680,4681,4682,4683,4701,4704,4719,4725,476,4764,477,4776,4779,4782,4785,4812,4818,5424,5425,7402,7407,7409,86,9081,9086,9089,9090,9091,9095,9126,9127,9128,9129,9130,9131,9132,9133,9440,9441,9442,9443,96,9631,9632,9633,9690,9691,97,4662,2907,4322,4665,4815,5016,5018,5694,2956,2904,4655,35,7414,2939,2950,4991,22,88,382,436,4906,4907,4908,4909,4910,4911,4912,4913,4914,4915,251,252,4385,388,399,400,12,82,2712,401,4382,444,4500,4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4512,4513,4514,4515,4516,4517,4518,4519,4520,4521,4522,4523,4524,4525,4526,4527,4528,4529,4530,4531,4532,4533,4534,4535,4536,4537,4538,4539,5027,5684,5695,7670,7671,7672,7673,7674,7675,7676,7677,7678,7679,7680,7681,7682,7683,7684,7685,7686,7687,7688,7689,7690,7691,7692,7693,7694,7695,7696,7697,7698,7699,2970,2720,36,4384,4386,94,4936,11200,11210,11220,11230,11240,11297,11298,11299,4937,4938,4939,149,29,2770,2771,2772,2773,2774,2775,2776,2777,2778,2779,2780,2781,2782,2783,2784,2785,2786,2787,2788,2789,7647,7648,7660,7661,7662,7663,7664,7665,7666,7667,7668,7669,7950,7951,7952,7953,7954,7955,7956,7957,127,30,2527,2528,2529,26,27,2714,28,443,81,91,92,93,191,33,157,20,2640,2641,2642,2643,2644,2645,2646,2647,2648,2649,465,466,467,468,469,470,471,472,473,474,125,126,199,2516,487,4872,4873,4874,108,11,11519,11520,136,137,156,249,250,253,255,256,4658,489,2971,168,2685,2912,2968,2969,4657,4857,5658,18,2716,2717,2718,2719,4550,4551,4552,4553,4554,4555,4556,4557,4558,4559,2510,2578,2670,2671,2672,2673,2674,2675,2680,2686,2721,2722,2723,2724,2725,2790,2791,2792,2793,2794,2795,2796,2797,2798,2799,387,7646,7900,7901,7902,7903,7904,7905,7906,7907,7908,7909 )
                       GROUP  BY 2,
                                 3,
                                 4,
                                 5) b
                WHERE  a.maprule = b.mapruleid
                       AND ( a.geoname = b.geo
                              OR a.geoname = 'GLOBAL'
                                 AND b.geo = '' )
                       AND ( a.netname = b.aslist
                              OR a.netname = 'ANY'
                                 AND b.aslist = '' )) ab,
               (SELECT region,
                       maprule_id,
                       Sum(bytes)    bytes,
                       Sum(bytes_in) bytes_in
                FROM   maprule_info d,
                       mcm_machines e
                WHERE  ghostip = ip
                       AND maprule_id IN ( 198,2905,2910,2923,2948,121,2911,1,122,151,152,197,290,2903,2916,2952,2957,2959,2962,3,332,4112,4114,4120,4663,4666,4667,4668,4669,9634,9636,9637,9638,9639,9644,9645,9646,2953,146,147,150,154,155,159,160,2,2913,2940,2941,2942,2943,2955,334,4992,95,4001,4002,4003,4004,480,481,482,4111,7401,2934,6,7,106,107,153,158,185,21,25,2906,2914,2919,2922,2924,2927,2928,2929,2935,2944,2945,2947,2951,2954,2964,2965,2966,2967,2972,2973,2983,31,4006,4007,4113,4116,4323,4363,4364,4370,4671,4672,4673,4674,4676,4677,4678,4679,4680,4681,4682,4683,4701,4704,4719,4725,476,4764,477,4776,4779,4782,4785,4812,4818,5424,5425,7402,7407,7409,86,9081,9086,9089,9090,9091,9095,9126,9127,9128,9129,9130,9131,9132,9133,9440,9441,9442,9443,96,9631,9632,9633,9690,9691,97,4662,2907,4322,4665,4815,5016,5018,5694,2956,2904,4655,35,7414,2939,2950,4991,22,88,382,436,4906,4907,4908,4909,4910,4911,4912,4913,4914,4915,251,252,4385,388,399,400,12,82,2712,401,4382,444,4500,4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4512,4513,4514,4515,4516,4517,4518,4519,4520,4521,4522,4523,4524,4525,4526,4527,4528,4529,4530,4531,4532,4533,4534,4535,4536,4537,4538,4539,5027,5684,5695,7670,7671,7672,7673,7674,7675,7676,7677,7678,7679,7680,7681,7682,7683,7684,7685,7686,7687,7688,7689,7690,7691,7692,7693,7694,7695,7696,7697,7698,7699,2970,2720,36,4384,4386,94,4936,11200,11210,11220,11230,11240,11297,11298,11299,4937,4938,4939,149,29,2770,2771,2772,2773,2774,2775,2776,2777,2778,2779,2780,2781,2782,2783,2784,2785,2786,2787,2788,2789,7647,7648,7660,7661,7662,7663,7664,7665,7666,7667,7668,7669,7950,7951,7952,7953,7954,7955,7956,7957,127,30,2527,2528,2529,26,27,2714,28,443,81,91,92,93,191,33,157,20,2640,2641,2642,2643,2644,2645,2646,2647,2648,2649,465,466,467,468,469,470,471,472,473,474,125,126,199,2516,487,4872,4873,4874,108,11,11519,11520,136,137,156,249,250,253,255,256,4658,489,2971,168,2685,2912,2968,2969,4657,4857,5658,18,2716,2717,2718,2719,4550,4551,4552,4553,4554,4555,4556,4557,4558,4559,2510,2578,2670,2671,2672,2673,2674,2675,2680,2686,2721,2722,2723,2724,2725,2790,2791,2792,2793,2794,2795,2796,2797,2798,2799,387,7646,7900,7901,7902,7903,7904,7905,7906,7907,7908,7909 )
                GROUP  BY 1,
                          2
                HAVING bytes > 10000) c
        WHERE  ab.maprule = c.maprule_id
               AND ab.regionid = c.region) abc,
       (SELECT casename,
               Sum(percentage) coverage_pct
        FROM   (SELECT Max(casename)   casename,
                       mapruleid,
                       geo,
                       aslist,
                       regionid,
                       Max(percentage) percentage
                FROM   a_maprule_qos_view_by_region
                WHERE  mapruleid IN ( 198,2905,2910,2923,2948,121,2911,1,122,151,152,197,290,2903,2916,2952,2957,2959,2962,3,332,4112,4114,4120,4663,4666,4667,4668,4669,9634,9636,9637,9638,9639,9644,9645,9646,2953,146,147,150,154,155,159,160,2,2913,2940,2941,2942,2943,2955,334,4992,95,4001,4002,4003,4004,480,481,482,4111,7401,2934,6,7,106,107,153,158,185,21,25,2906,2914,2919,2922,2924,2927,2928,2929,2935,2944,2945,2947,2951,2954,2964,2965,2966,2967,2972,2973,2983,31,4006,4007,4113,4116,4323,4363,4364,4370,4671,4672,4673,4674,4676,4677,4678,4679,4680,4681,4682,4683,4701,4704,4719,4725,476,4764,477,4776,4779,4782,4785,4812,4818,5424,5425,7402,7407,7409,86,9081,9086,9089,9090,9091,9095,9126,9127,9128,9129,9130,9131,9132,9133,9440,9441,9442,9443,96,9631,9632,9633,9690,9691,97,4662,2907,4322,4665,4815,5016,5018,5694,2956,2904,4655,35,7414,2939,2950,4991,22,88,382,436,4906,4907,4908,4909,4910,4911,4912,4913,4914,4915,251,252,4385,388,399,400,12,82,2712,401,4382,444,4500,4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4512,4513,4514,4515,4516,4517,4518,4519,4520,4521,4522,4523,4524,4525,4526,4527,4528,4529,4530,4531,4532,4533,4534,4535,4536,4537,4538,4539,5027,5684,5695,7670,7671,7672,7673,7674,7675,7676,7677,7678,7679,7680,7681,7682,7683,7684,7685,7686,7687,7688,7689,7690,7691,7692,7693,7694,7695,7696,7697,7698,7699,2970,2720,36,4384,4386,94,4936,11200,11210,11220,11230,11240,11297,11298,11299,4937,4938,4939,149,29,2770,2771,2772,2773,2774,2775,2776,2777,2778,2779,2780,2781,2782,2783,2784,2785,2786,2787,2788,2789,7647,7648,7660,7661,7662,7663,7664,7665,7666,7667,7668,7669,7950,7951,7952,7953,7954,7955,7956,7957,127,30,2527,2528,2529,26,27,2714,28,443,81,91,92,93,191,33,157,20,2640,2641,2642,2643,2644,2645,2646,2647,2648,2649,465,466,467,468,469,470,471,472,473,474,125,126,199,2516,487,4872,4873,4874,108,11,11519,11520,136,137,156,249,250,253,255,256,4658,489,2971,168,2685,2912,2968,2969,4657,4857,5658,18,2716,2717,2718,2719,4550,4551,4552,4553,4554,4555,4556,4557,4558,4559,2510,2578,2670,2671,2672,2673,2674,2675,2680,2686,2721,2722,2723,2724,2725,2790,2791,2792,2793,2794,2795,2796,2797,2798,2799,387,7646,7900,7901,7902,7903,7904,7905,7906,7907,7908,7909 )
                GROUP  BY 2,
                          3,
                          4,
                          5)
        GROUP  BY 1) d
WHERE  abc.casename = d.casename
GROUP  BY 2